<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Assistant</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: #f1f3f6;
        display: flex;
        justify-content: center;
        padding-top: 50px;
        transition: background 0.3s, color 0.3s;
    }
    body.dark-mode { background: #1e1e2f; color: #e0e0e0; }

    .container {
        width: 500px;
        max-width: 95%;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        padding: 20px;
        display: flex;
        flex-direction: column;
        height: 80vh;
    }
    body.dark-mode .container { background: #2b2b3f; }

    h1 {
        font-size: 2.5rem;
        text-align: center;
        margin-bottom: 20px;
        background: linear-gradient(90deg, #4285f4, #ea4335, #fbbc05, #34a853);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    #darkToggle {
        background: #555;
        color: white;
        margin-bottom: 10px;
        padding: 8px 12px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
    }
    #darkToggle:hover { background: #333; }

    .chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        border-radius: 10px;
        background: #f7f7f7;
        margin-bottom: 20px;
    }
    body.dark-mode .chat-box { background: #3a3a50; }

    .chat-entry { margin-bottom: 15px; display: flex; flex-direction: column; }
    .query, .response {
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 75%;
        word-wrap: break-word;
    }
    .query { background: #4285f4; color: #fff; align-self: flex-end; }
    .response { background: #e0e0e0; color: #000; align-self: flex-start; }
    body.dark-mode .response { background: #4a4a6a; color: #fff; }

    .input-area { display: flex; gap: 10px; }
    input[type=text] {
        flex: 1;
        padding: 12px 20px;
        border-radius: 25px;
        border: 1px solid #ccc;
        outline: none;
        font-size: 1rem;
    }
    input[type=text]:focus { border-color: #4285f4; box-shadow: 0 0 5px rgba(66,133,244,0.5); }

    button {
        padding: 12px 18px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s;
    }
    #submitBtn { background: #4285f4; color: white; }
    #submitBtn:hover { background: #3367d6; }
    #micBtn { background: #34a853; color: white; }
    #micBtn:hover { background: #2c8c47; }
</style>
</head>
<body>
<div class="container">
    <h1>Personal Voice Assistant</h1>
    <button id="darkToggle">ðŸŒ™</button>

    <div class="chat-box" id="chatBox">
        {% for chat in chat_history %}
        <div class="chat-entry">
            <div class="query">You: {{ chat.query }}</div>
            <div class="response">{{ chat.response|safe }}</div>
        </div>
        {% endfor %}
    </div>

    <form class="input-area" id="chatForm">
        {% csrf_token %}
        <input type="text" id="queryBox" name="query" placeholder="Ask me anything...">
        <button type="submit" id="submitBtn">Send</button>
        <button type="button" id="micBtn">ðŸŽ¤</button>
    </form>
</div>

<script>
    const queryBox = document.getElementById("queryBox");
    const chatBox = document.getElementById("chatBox");

    document.getElementById("darkToggle").addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
    });

    document.getElementById("micBtn").addEventListener("click", () => {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = "en-IN";
        recognition.start();
        recognition.onresult = event => { queryBox.value = event.results[0][0].transcript; };
        recognition.onerror = event => { alert("Error: " + event.error); };
    });

    function addChatMessage(userText, assistantText) {
        const entry = document.createElement("div");
        entry.classList.add("chat-entry");

        const userDiv = document.createElement("div");
        userDiv.classList.add("query");
        userDiv.innerText = "You: " + userText;

        const botDiv = document.createElement("div");
        botDiv.classList.add("response");
        botDiv.innerHTML = assistantText;  // Important: use innerHTML for links

        entry.appendChild(userDiv);
        entry.appendChild(botDiv);
        chatBox.appendChild(entry);

        chatBox.scrollTop = chatBox.scrollHeight;

        const msg = new SpeechSynthesisUtterance(botDiv.innerText);
        msg.lang = "en-IN";
        window.speechSynthesis.speak(msg);
    }

    document.getElementById("chatForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const userInput = queryBox.value.trim();
        if (!userInput) return;

        fetch("{% url 'assistant_api' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({ query: userInput })
        })
        .then(response => response.json())
        .then(data => addChatMessage(userInput, data.response))
        .catch(() => addChatMessage(userInput, "Sorry, I couldn't process that."));

        queryBox.value = "";
    });

    chatBox.scrollTop = chatBox.scrollHeight;
</script>
</body>
</html>
